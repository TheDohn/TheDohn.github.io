<!DOCTYPE html>
<html lang="en">
     <head>
          <meta charset="utf-8">
          <title>Twitter Elections Integrity Archive Most retweeted accounts</title>
     <script src = "https://d3js.org/d3.v5.min.js"></script>
     <!-- <script src="d3_v5.js"></script> -->
     <!-- <script src = "https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.3.0/fuse.min.js"> -->
     <!-- <script src="lunr.js"> -->
     <script src="https://unpkg.com/lunr/lunr.js"></script>
<!--      <script src="combinatorics.js"></script> -->

</script>

<!--  Format text.-->
<style type="text/css">
<!--
.tab { margin-left: 40px;
margin-right: 40px; }
-->
</style>


     </script>
     <style type="text/css">

     html,body {
          width: 100%;
          height: 100%;
          margin: 2px;
          padding: 0px;
          overflow-x: hidden;
     }

     input {border: 1px solid #ccc; background: white;
           padding: 0px 0px; font-size: 12px; margin: 0px 0px 0px 0;}
     /* input:focus { background-color:yellow; outline: none;}font-family: monospace; */


     /*mouseover display */
     #hover_display {
          position: absolute;
          width: 400px;
          height: auto;
          padding: 10px;
          background-color: white;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
          border-radius: 10px;
          -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
          -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
          box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
          pointer-events: none;
     }
     #hover_display.hidden {
          display: none;
     }
     #hover_display p {
          margin: 0;
          font-family: sans-serif;
          font-size: 16px;
          line-height: 20px;
     }


     .tool_panel{
          overflow: hidden;
          border: solid;
          border-color: black;
          border-width: 1px;
          height: 100px;
          width: 1100px;
     }


     /*  Allows you to click svg behind text. */
     .no_event_text {
        pointer-events: none;
     }



     #x_sort_descrip{
          position:relative;
          top:-10px;
          left:20px;
     }

     #x_dropdown{
          position:relative;
          top:-25px;
          left:20px;
     }

     #x_axis_sort_label{
          position:relative;
          top:600px;
          left:500px;
     }



     #y_sort_descrip{
          position:relative;
          top:-80px;
          left:200px;
     }

     #y_dropdown{
          position:relative;
          top:-93px;
          left:200px;
     }

     #y_axis_sort_label{
          position:relative;
          top:350px;
          left:500px;
     }

     /* Otherwise this drag goes underneith scatter plot*/
     textarea {
       resize: none;
     }



      .text_search_class{
           /* height: 40px; */
           /* width: 130px; */
           left: 530px;
           top:-170px;
           position: relative;
      }

     .button_class{
           overflow: hidden;
           height: 40px;
           width: 130px;
           left: 830px;
           top:-243px;
           position: relative;
      }



     .scatter_plot_div{
          position: relative;
     }


     .color_map_class{
           overflow: hidden;
           border: solid;
           border-color: black;
           border-width: 1px;
           height: 679px;
           width: 150px;
           left: 1270px;
           top:10px;
           position: absolute;
      }

     </style>
     </head>

<body>


<!-- introduction text at very top -->
<div class="introduction">
     <p class = "tab"> Below are the most retweeted English tweets from the <a href="https://about.twitter.com/en_us/values/elections-integrity.html#data"> Twitter Elections Integrity Archive </a>.
      This data "...include[s] information from 3,841 accounts believed to be connected to the Russian Internet Research Agency, and 770 accounts believed to originate in Iran."



<p class = "tab"> Things you can play with:</p>
<ul  class = "tab">


     <li>Each circle represents a tweet. By manipulating the drop down menus below, you can alter how the accounts are displayed.
     <li>Each drop down has the following options, inluding ratios of the following:
          <ul >
               <li>retweets: <em> The total number of retweets for the tweet.</em>
               <li>followers: <em> The total number of followers of the account.</em>
               <li>following: <em> The total number of accounts the account is following.</em>
               <li>replies: <em> The total number of replies for the tweet.</em>
               <li>likes: <em> The total number of likes for the tweet.</em>
          </ul>
     <li> Enter multiple search terms (20 max) in the box to the left of the search button, one per line,
          and click on the search button to search for those terms. The search is powered by <a href = "https://lunrjs.com/">Lunr</a>.
     <li> By hovering over each circle, additional details, including the tweet text is displayed.
     <li> By clicking on a given tweet, all other tweets for that user are highlighted. Clicking outside the circles, but within the plot area, will reset the opacity.
</ul>

<p class = "tab"> Things to note:</p>
<ul  class = "tab">
     <li> The color coding map for each term is displayed in the box on the right.
     <li> Extremely common words like "the" and "to" have been removed. Words have been "stemmed" so that "walk" will hit on "walks" and "walking".
     <li> Due to the large area of the display, I suggest using full screen mode.
     <li> You might notice is that each circle does not always line up with the corresponding
          value on the axis. This is due the "jitter" I have introduced in order to avoid the cirlces overlapping.
          Otherwise many circles would overlap, and it would be very hard to see.
     <li> Please note that I have only tested this in Chrome.

</ul>
</div>


<!-- drop down menus -->
<div class="tool_panel">

     <h3>Select the Twitter account attributes to display: </h3>

     <div class = "x_axis_sort" >
          <p id = 'x_sort_descrip'>Horizontal position: </p>

          <select id="x_dropdown">
               <option value = "retweet_count" selected="selected">retweets</option>
               <option value = "follower_count" >followers</option>
               <option value = "following_count"> following</option>
               <option value = "reply_count" >replies</option>
               <option value = "like_count" >likes</option>
               <option value = "retweet_count_D_follower_count">retweets/followers</option>
               <option value = "follower_count_D_retweet_count"> followers/retweets</option>
               <option value = "retweet_count_D_following_count"> retweets/following</option>
               <option value = "following_count_D_retweet_count"> following/retweets</option>
               <option value = "follower_count_D_following_count"> followers/following</option>
               <option value = "following_count_D_follower_count"> following/followers</option>
          </select>
     </div>



     <div class = "y_axis_sort" >
          <p id = 'y_sort_descrip'>Vertical position:</p>

          <select id="y_dropdown">
               <option value = "retweet_count">retweets</option>
               <option value = "follower_count" >followers</option>
               <option value = "following_count"> following</option>
               <option value = "reply_count"  selected="selected">replies</option>
               <option value = "like_count" >likes</option>
               <option value = "retweet_count_D_follower_count">retweets/followers</option>
               <option value = "follower_count_D_retweet_count"> followers/retweets</option>
               <option value = "retweet_count_D_following_count"> retweets/following</option>
               <option value = "following_count_D_retweet_count"> following/retweets</option>
               <option value = "follower_count_D_following_count"> followers/following</option>
               <option value = "following_count_D_follower_count"> following/followers</option>
          </select>
     </div>


     <textarea class = "text_search_class" id = "myVal" name="Text1"
               cols="40" rows="6" maxlength="2000"
               placeholder="Type search terms here, one per line."></textarea>

     <!-- empty div to add button within d3.csv(...) code. NEED to add it there or else click w/in d3.csv(...) doesn't work -->
     <div class = "button_class" >
     </div>

</div>
<!-- *******end drop down menus ***********************************-->
<!--  **********************************************************************-->
<!--  **********************************************************************-->

<div class="scatter_plot_div">

     <div class = "color_map_class" >
     </div>

</div>


<!-- mouseover  -->
<div id = "hover_display" class = "hidden">
     <p id = "userhandle"></p>
     <p id = "user_profile_descrp"></p>
     <p id = "follower_count" </p>
     <p id = "following_count" </p>
     <p id = "retweet_count" </p>
     <p id = "likes" </p>
     <p id = "replies" </p>
     <p id = "tweet_text"></p>
</div><!-- end mouseover  -->

<!--  *******END DIVS*******************************************************-->
<!--  **********************************************************************-->
<!--  **********************************************************************-->


<script type="text/javascript">




     // def plot sizing, padding, transition time
     var plot_top = 20;
     var plot_w = 1280; //1480 is about max
     var plot_h = 730;  // 580 is about max
     var x_pad = 1;
     var tran_time = 1000;

     var set_inner_radius = 0;
     var set_outer_radius = 4;

     // counter for color_dict I want to initialize only once
     var jj = 0;

     var color_default = "black";

     //add more colors
     // var color_list = [ "blue", "green", "red","purple", "cyan", "gray", "hotpink", "gold", "navy",
     //                     "lime", "peru", "teal", "darkviolet", "deepink"    ];

     //var color_list = [d3.interpolateSpectral(.1),d3.interpolateSpectral(.2),d3.interpolateSpectral(.5)]
     //var color_list = [d3.schemeBlues(.5),d3.interpolateRainbow(.2),d3.interpolateRainbow(.5)]

     // colors from http://jnnnnn.github.io/category-colors-constrained.html //"#0b7b3e", grey
     var color_list = ["#3957ff", "#d3fe14", "#c9080a", "#fec7f8",  "#0bf0e9", "#c203c8", "#fd9b39", "#888593",
                         "#906407", "#98ba7f", "#fe6794", "#10b0ff", "#ac7bff", "#fee7c0", "#964c63", "#1da49c", "#0ad811",
                         "#bbd9fd", "#fe6cfe", "#297192", "#d1a09c", "#78579e", "#81ffad", "#739400", "#ca6949", "#d9bf01",
                         "#646a58", "#d5097e", "#bb73a9", "#ccf6e9", "#9cb4b6", "#b6a7d4", "#9e8c62", "#6e83c8", "#01af64",
                         "#a71afd", "#cfe589", "#d4ccd1", "#fd4109", "#bf8f0e", "#2f786e", "#4ed1a5", "#d8bb7d", "#a54509",
                         "#6a9276", "#a4777a", "#fc12c9", "#606f15", "#3cc4d9", "#f31c4e", "#73616f", "#f097c6", "#fc8772",
                         "#92a6fe", "#875b44", "#699ab3", "#94bc19", "#7d5bf0", "#d24dfe", "#c85b74", "#68ff57", "#b62347",
                         "#994b91", "#646b8c", "#977ab4", "#d694fd", "#c4d5b5", "#fdc4bd", "#1cae05", "#7bd972", "#e9700a",
                         "#d08f5d", "#8bb9e1", "#fde945", "#a29d98", "#1682fb", "#9ad9e0", "#d6cafe", "#8d8328", "#b091a7",
                         "#647579", "#1f8d11", "#e7eafd", "#b9660b", "#a4a644", "#fec24c", "#b1168c", "#188cc1", "#7ab297",
                         "#4468ae", "#c949a6", "#d48295", "#eb6dc2", "#d5b0cb", "#ff9ffb", "#fdb082", "#af4d44", "#a759c4",
                         "#a9e03a", "#0d906b", "#9ee3bd", "#5b8846", "#0d8995", "#f25c58", "#70ae4f", "#847f74", "#9094bb",
                         "#ffe2f1", "#a67149", "#936c8e", "#d04907", "#c3b8a6", "#cef8c4", "#7a9293", "#fda2ab", "#2ef6c5",
                         "#807242", "#cb94cc", "#b6bdd0", "#b5c75d", "#fde189", "#b7ff80", "#fa2d8e", "#839a5f", "#28c2b5",
                         "#e5e9e1", "#bc79d8", "#7ed8fe", "#9f20c3", "#4f7a5b", "#f511fd", "#09c959", "#bcd0ce", "#8685fd",
                         "#98fcff", "#afbff9", "#6d69b4", "#5f99fd", "#aaa87e", "#b59dfb", "#5d809d", "#d9a742", "#ac5c86",
                         "#9468d5", "#a4a2b2", "#b1376e", "#d43f3d", "#05a9d1", "#c38375", "#24b58e", "#6eabaf", "#66bf7f",
                         "#92cbbb", "#ddb1ee", "#1be895", "#c7ecf9", "#a6baa6", "#8045cd", "#5f70f1", "#a9d796", "#ce62cb",
                         "#0e954d", "#a97d2f", "#fcb8d3", "#9bfee3", "#4e8d84", "#fc6d3f", "#7b9fd4", "#8c6165", "#72805e",
                         "#d53762", "#f00a1b", "#de5c97", "#8ea28b", "#fccd95", "#ba9c57", "#b79a82", "#7c5a82", "#7d7ca4",
                         "#958ad6", "#cd8126", "#bdb0b7", "#10e0f8", "#dccc69", "#d6de0f", "#616d3d", "#985a25", "#30c7fd",
                         "#0aeb65", "#e3cdb4", "#bd1bee", "#ad665d", "#d77070", "#8ea5b8", "#5b5ad0"]


     var color_dict = [{"search_term":'NA',"num":1, "color":color_default},
                       {"search_term":'trump',"num":2, "color":"orangeRed"}]; //oh please, this is just funny.


     //search button
     var svg_button = d3.select("body")
                         .selectAll("div.button_class")
                         .append("svg")
                         .attr("width", 130)
                         .attr("height", 100)

     svg_button.append("rect")
               .attr("x",1)
               .attr("y",1)
               .attr("width", 128)
               .attr("height", 34)
               .attr("fill", "LightGray")
               .style("stroke", "DarkGray")
               .style("stroke-width",1)

     svg_button.append("text")
               .attr("class","no_event_text")
               .attr("x",18)
               .attr("y",23)
               .attr("fill","Gray")
               .text('Click to search')

     // mouseover for search button
     svg_button.on("mouseover", function(){

          d3.select(this)
               .select("rect")
               .style("stroke","black")

          d3.select(this)
               .select("text")
               .attr('fill','black')

          d3.select(this)
               .attr("drop-shadow")

                    })
               .on("mouseout",function(){

                    d3.select(this)
                         .select("rect")
                         .style("stroke","DarkGray")


                    d3.select(this)
                         .select("text")
                         .attr('fill','Gray')
                    })


     // account circles
     var svg_plot = d3.select("body")
                    .select("div.scatter_plot_div")
                    .append("svg")
                    .attr("id","svg_plot_area")
                    .attr("width", plot_w)
                    .attr("height", plot_top + plot_h + 100)
                    .attr("x",0)
                    .attr("y",0)

     var x_axis_label = svg_plot.append("text")
                                   .attr("class", "axis_labels")
                                   .attr("id", "x_axis_sort_label")
                                   .attr("x",plot_w/2)
                                   .attr("y",plot_h + 60)
                                   .attr("fill","black")
                                   .text("x axis")

     var y_axis_label = svg_plot.append("text")
                                   .attr("class", "axis_labels")
                                   .attr("id", "y_axis_sort_label")
                                   .attr("x",20)
                                   .attr("y",20)
                                   .attr("fill","black")
                                   .text("y axis")

     // initialize the data row on the first pass with import
     var row_initializer = function(row){

          return {
               tweetid: row.tweetid,
               userid: row.userid,
               user_display_name: row.user_display_name,
               user_screen_name: row.user_screen_name,
               user_profile_description: row.user_profile_description,
               tweet_text: row.tweet_text,
               retweet_count: +row.retweet_count,
               follower_count: +row.follower_count,
               following_count: +row.following_count,
               reply_count: +row.reply_count,
               like_count: +row.like_count,
               retweet_count_D_follower_count: (+row.retweet_count)/(+row.follower_count),
               follower_count_D_retweet_count: (+row.follower_count)/(+row.retweet_count),
               retweet_count_D_following_count: (+row.retweet_count)/(+row.following_count),
               following_count_D_retweet_count: (+row.following_count)/(+row.retweet_count),
               follower_count_D_following_count: (+row.follower_count)/(+row.following_count),
               following_count_D_follower_count: (+row.following_count)/(+row.follower_count),
               x_pos: "",
               y_pos: "",
               contains:["NA"],
          };
     }; // row_initializer def




     // get corresponding property for the drop down selection as we update
     // seems ugly, but cant find a better way
     // for some props I have choosen Log by hand since display is ugly otherwise.
     function get_prop(row, pick_prop){

          if(pick_prop=="retweet_count"){return row.retweet_count}
          if(pick_prop=="follower_count"){return row.follower_count}
          if(pick_prop=="following_count"){return row.following_count}
          if(pick_prop=="reply_count"){return row.reply_count}
          if(pick_prop=="like_count"){return row.like_count}
          if(pick_prop=="retweet_count_D_follower_count"){return row.retweet_count_D_follower_count}
          if(pick_prop=="follower_count_D_retweet_count"){return row.follower_count_D_retweet_count}
          if(pick_prop=="retweet_count_D_following_count"){return row.retweet_count_D_following_count}
          if(pick_prop=="following_count_D_retweet_count"){return row.following_count_D_retweet_count}
          if(pick_prop=="follower_count_D_following_count"){return row.follower_count_D_following_count}
          if(pick_prop=="following_count_D_follower_count"){return row.following_count_D_follower_count}
     };


     function get_nice_label(pick_prop){

          if(pick_prop=="retweet_count"){return "retweets"}
          if(pick_prop=="follower_count"){return "followers" }
          if(pick_prop=="following_count"){return "following"}
          if(pick_prop=="reply_count"){return "replies"}
          if(pick_prop=="like_count"){return "likes"}
          if(pick_prop=="retweet_count_D_follower_count"){return "retweets/followers"}
          if(pick_prop=="follower_count_D_retweet_count"){return "followers/retweets"}
          if(pick_prop=="retweet_count_D_following_count"){return "retweets/following"}
          if(pick_prop=="following_count_D_retweet_count"){return "following/retweets"}
          if(pick_prop=="follower_count_D_following_count"){return "followers/following"}
          if(pick_prop=="following_count_D_follower_count"){return "following/followers"}

     };


     //for filtering out blank search terms
     function my_filter(x){
          if(x!=""){return x}
                         }
//*** INITIALIZE CSV ****************************************************
     d3.csv("top_1000_tweets_df.csv", row_initializer)
       .then(function(data_in){


//*** INITIALIZE VARS AND FUNCTION DEFS ****************************************************
//******************************************************************************************

          // Initialize the height, width, sort attributes
          var x_pos_input = d3.select("#x_dropdown").property("value")
          var y_pos_input = d3.select("#y_dropdown").property("value")
          var data_in_length = data_in.length

          // color map variables
          var c_map_y_inc = 10;
          var c_map_x = 10;
          var c_map_r = 5;

          var opacity_on = false;

          // something to click on to reset opacity
          // THIS HAS TO BE BUILT BEFORE pie_groups!
          background_rect = svg_plot.append("rect")
                                   .attr("height",plot_h+50)
                                   .attr("width",plot_w+50)
                                   .attr("x",0)
                                   .attr("y",0)
                                   .attr("fill","white")
                                   .attr("opacity",0)

          // THESE HAVE TO BE BUILT BEFORE THE AXIS GROUPS!
          var pie_groups = svg_plot.selectAll("g")
                              .data(data_in)
                              .enter()
                              .append("g")
                              .attr("class", "pie")// needs specific class name for searching later
                              .attr("id", function(d,i){ return "g" + d.tweetid.toString();})

          // update the horizontal position
          function x_pos_updater(x_pos_input){

               // give it some buffer to avoid going outside svg, maybe a better way?
               var x_buffer = 20;

               //get min, max x position
               var min_x_pos = 10000; // this is 0 for linear, have to be non zero for log. fix this.
               var max_x_pos = 2;
               for(i=0;i<data_in.length;i++){
                    min_x_pos = Math.min(  get_prop(data_in[i], x_pos_input) , min_x_pos)
                    max_x_pos = Math.max(  get_prop(data_in[i], x_pos_input) , max_x_pos)

               }



               // update x scaler to either linear or log scale as needed
               if(x_pos_input=="following_count" || x_pos_input=="follower_count" ){
                    var x_scaler = d3.scaleLinear()
                                     .domain([min_x_pos, max_x_pos])
                                     .range([x_buffer*set_outer_radius, plot_w-x_buffer*set_outer_radius]);
               }else{
                    var x_scaler = d3.scaleLog()
                                     .domain([min_x_pos, max_x_pos])
                                     .range([x_buffer*set_outer_radius, plot_w-x_buffer*set_outer_radius]);
               }

               // calculate the new x positions
               for(i=0;i<data_in.length;i++){
                    data_in[i].x_pos = x_scaler(get_prop(data_in[i], x_pos_input))
               }

               var x_Axis = d3.axisBottom()
                              .scale(x_scaler);

               // if the x axis does not exist, build it, otherwise update it
               if(svg_plot.select(".x_axis").empty()){
                    svg_plot.append("g")
                              .attr("class", "x_axis")
                              .attr("transform", "translate(0," + (plot_h+30) + ")" )
                              .call(x_Axis);
               }
               else{

                    svg_plot.select(".x_axis")
                              .transition()
                              .duration(tran_time)
                              .call(x_Axis);
               }

          } // end x position update




          // update the vertical position
          function y_pos_updater(x_pos_input){

               // give it some buffer to avoid going outside svg, maybe a better way?
               var y_buffer = 20;

               //get min, max x position
               var min_y_pos = 1000;
               var max_y_pos = 2;
               for(i=0;i<data_in.length;i++){
                    min_y_pos = Math.min(  get_prop(data_in[i], y_pos_input) , min_y_pos)
                    max_y_pos = Math.max(  get_prop(data_in[i], y_pos_input) , max_y_pos)
               }


               // update y scaler to either linear or log scale as needed
               if(y_pos_input=="following_count" || y_pos_input=="follower_count" ){
                    var y_scaler = d3.scaleLinear()
                                     .domain([min_y_pos, max_y_pos])
                                     .range([ plot_h-y_buffer*set_outer_radius,y_buffer*set_outer_radius]);
                                        // 2s keep force-directed pies inside better, bit of a hack for now.
               }else{
                    var y_scaler = d3.scaleLog()
                                     .domain([min_y_pos, max_y_pos])
                                     .range([ plot_h-y_buffer*set_outer_radius,y_buffer*set_outer_radius]);
                                        // 2s keep force-directed pies inside better, bit of a hack for now.
               }

               // calculate the new y positions
               for(i=0;i<data_in.length;i++){
                    data_in[i].y_pos =  y_scaler( get_prop(data_in[i], y_pos_input))
               }

               var y_Axis = d3.axisLeft()
                              .scale(y_scaler);

               // if the y axis does not exist, build it, otherwise update it
               if(svg_plot.select(".y_axis").empty()){
                    svg_plot.append("g")
                              .attr("class", "y_axis")
                              .attr("transform", "translate(45,0 )")
                              .call(y_Axis);
               }
               else{

                    svg_plot.select(".y_axis")
                              .transition()
                              .duration(tran_time)
                              .call(y_Axis);
               }



          } // end y position update




          function find_all_users_tweets(user_id){

               var this_users_tweet_ids = []
               var other_users_tweet_ids = []

                         for(i=0;i<data_in.length;i++){
                              if(data_in[i].userid==user_id){

                              this_users_tweet_ids.push(data_in[i].tweetid)
                              }
                              else{
                              other_users_tweet_ids.push(data_in[i].tweetid)
                              }

                         }
                    return {"this_users_tweet_ids":this_users_tweet_ids,"other_users_tweet_ids":other_users_tweet_ids}
                    }


                    // for moving tweets to front from http://bl.ocks.org/eesur/4e0a69d57d3bfc8a82c2
                    d3.selection.prototype.moveToFront = function() {
                          return this.each(function(){
                            this.parentNode.appendChild(this);
                          });
                        };

//*** END INITIALIZE VARS AND FUNCTION DEFS ************************************************
//******************************************************************************************


//*** BEGIN UPDATE INITIAL BUILD************************************************
//******************************************************************************************
     x_pos_updater(x_pos_input)
     y_pos_updater(y_pos_input)

     d3.select("body")
       .select("#x_axis_sort_label")
       .text(get_nice_label(x_pos_input))

     d3.select("body")
       .select("#y_axis_sort_label")
       .text(get_nice_label(y_pos_input))

     pie_groups.attr("transform", function(d){return "translate(" + d.x_pos + "," + d.y_pos + ")"})

     //Draw initial arc paths and color: 1 black wedge for now
     pie_groups.selectAll("path")
               .data(function(d,i){
                         return d3.pie()([1])  //these just have 1 wedge for now
                         })
               .enter()
               .append("path")
               .attr("d",function(d,i){
                              return d3.arc()
                                        .innerRadius(set_inner_radius)
                                        .outerRadius(set_outer_radius)(d)
                         })
               .attr("fill",function(d,i){
                              return "black"
                              })




          // constrains pies inside plot_svg,
          // make sure this works on all edges
          // this doesn't work because it supercedes force, which causes overlap
          // added padding to scaler for now, try to find a better way.
          function x_constraint(x_try){
               if(x_try<set_outer_radius){return set_outer_radius}
               else if(x_try>plot_w){return plot_w-set_outer_radius}
               else {return x_try}
               }

          function y_constraint(y_try){
               if(y_try<set_outer_radius){return set_outer_radius}
               else if(y_try>plot_h){return plot_h-set_outer_radius}
               else {return y_try}
               }

          // force repels each circle so there is no overlap, and attracts each circle to its "proper" location
          var make_room_by_force = d3.forceSimulation(data_in)
                                        .force('x', d3.forceX(function(d) {
                                                                 return d.x_pos
                                                       }))
                                        .force('y', d3.forceY(function(d) {
                                                                  return d.y_pos
                                                       }))
                                        // strength should technically only be up to 1, but larger works faster
                                        .force("collide", d3.forceCollide().radius(1.01*set_outer_radius).strength(1.0))



          make_room_by_force.on("tick",

                    function(){pie_groups.attr("transform", function(d){

                              var new_x = d.x // var new_x = x_constraint(d.x)
                              var new_y = d.y // var new_y = y_constraint(d.y)

                              return "translate(" + new_x + "," + new_y + ")"})
                    }
          )

//*** END INITIAL BUILD ************************************************
//******************************************************************************************


          pie_groups.on("mouseover",function(d,i){

                               //Update the hover_display position and value
                               d3.select("#hover_display")
                                 .style("left", 800 + "px")
                                 .style("top", plot_top + 0 + "px")
                                 .style("width", function(){ return 500 + "px" })
                                   .moveToFront()

                               d3.select("#hover_display")
                                 .select("#userhandle")
                                 .text( d.user_display_name + "@" + d.user_screen_name)
                               d3.select("#hover_display")
                                 .select("#user_profile_descrp")
                                 .text(d.user_profile_description)
                               d3.select("#hover_display")
                                 .select("#follower_count")
                                 .text("followers: " + d.follower_count)
                               d3.select("#hover_display")
                                 .select("#following_count")
                                 .text("following: " + d.following_count)
                               d3.select("#hover_display")
                                 .select("#retweet_count")
                                 .text("retweets: " + d.retweet_count)
                               d3.select("#hover_display")
                                 .select("#likes")
                                 .text("likes: " +d.like_count)
                               d3.select("#hover_display")
                                 .select("#replies")
                                 .text("replies: " +d.reply_count)
                               d3.select("#hover_display")
                                  .select("#tweet_text")
                                  .text(d.tweet_text)

                              //Show/hide the hover_display
                              d3.select("#hover_display").classed("hidden", false);})
                                   .on("mouseout",function(){
                                        d3.select("#hover_display").classed("hidden", true)
                              })// close the mouseout



          pie_groups.on('click',function(d){

               if(opacity_on==true){
               pie_groups.attr("opacity", 1)
               opacity_on=false
               }

                    var other_users_tweet_ids = find_all_users_tweets(d.userid).other_users_tweet_ids

                    for(i=0;i<other_users_tweet_ids.length;i++){

                         d3.selectAll(".pie")
                              .filter("#g" + other_users_tweet_ids[i])
                              .attr("opacity", .3)

                         }

               opacity_on = true
               })

               background_rect.on("click",function(){

                    if(opacity_on==true){
                    pie_groups.attr("opacity", 1)
                    opacity_on=false
                    }

               })




          // display color map for words, rough for now
          c_map_svg = d3.select("body")
                         .select("div.color_map_class")
                         .selectAll("svg")
                         .data(['NA'])
                         .enter()
                         .append("svg")

          c_map_svg.append("circle")
                    .attr("cx",c_map_x)
                    .attr("cy",c_map_y_inc)
                    .attr("r",c_map_r)
                    .attr("fill","black")

          c_map_svg.append("text")
                         .attr("x",c_map_x + 2*c_map_r)
                         .attr("y",c_map_y_inc + c_map_r)
                         .text(function(d,i){ return d })







               //update horizontal sort
               d3.select("#x_dropdown")
                 .on("change", function(d){

                    //get new x sort property
                    x_pos_input = d3.select("#x_dropdown").property("value");

                    // update and resort data
                    x_pos_updater(x_pos_input)


                    svg_plot.selectAll("g")
                         .selectAll(".pie")
                         .data(data_in)
                         .transition()
                         .duration(tran_time)
                         .attr("transform", function(d){return "translate(" + d.x_pos + "," + d.y_pos + ")"})
                       //.attr("cx", function(d,i){ return d.x_pos })

                       var make_room_by_force = d3.forceSimulation(data_in)
                                                    .force('x', d3.forceX(function(d) { return d.x_pos }))
                                                    .force('y', d3.forceY(function(d) { return d.y_pos }))
                                                    .force("collide", d3.forceCollide().radius(set_outer_radius))

                         make_room_by_force.on("tick",

                              function(){pie_groups.attr("transform", function(d){

                                          var new_x = d.x
                                          var new_y = d.y

                                          return "translate(" + new_x + "," + new_y + ")"})
                              }
                         )

                    d3.select("body")
                      .select("#x_axis_sort_label")
                      .text(get_nice_label(x_pos_input))

               }) //close horizontal sort update



               //update vertical sort
               d3.select("#y_dropdown")
                .on("change", function(d){

                    //get new x sort property
                    y_pos_input = d3.select("#y_dropdown").property("value");

                    // update and resort data
                    y_pos_updater(y_pos_input)

                    //rezero position for sorting
                    prior_y = 0;

                    svg_plot.selectAll("g")
                           .selectAll(".pie")
                           .data(data_in)
                           .transition()
                           .duration(tran_time)
                           .attr("transform", function(d){return "translate(" + d.x_pos + "," + d.y_pos + ")"})

                           var make_room_by_force = d3.forceSimulation(data_in)
                                                         .force('x', d3.forceX(function(d) { return d.x_pos }))
                                                         .force('y', d3.forceY(function(d) { return d.y_pos }))
                                                         .force("collide", d3.forceCollide().radius(set_outer_radius))

                    make_room_by_force.on("tick",

                         function(){pie_groups.attr("transform", function(d){

                              var new_x = d.x
                              var new_y = d.y

                              return "translate(" + new_x + "," + new_y + ")"})
                         }
                    )

                    d3.select("body")
                      .select("#y_axis_sort_label")
                      .text(get_nice_label(y_pos_input))

               }) //close vertical sort update



               // after click on "search" button, search and process results
               svg_button.select("rect")
                         .on("click", function(){

                    var initial_search_string = "";
                    var individual_search_terms;
                    var final_terms = [];

                    // get search terms, split by lines, eliminate blanks, trim leading/trailing whitespace, get unique terms
                    initial_search_string = d3.select("#myVal").property("value");
                    individual_search_terms = initial_search_string.split("\n");
                    individual_search_terms = individual_search_terms.filter(my_filter);
                    individual_search_terms = individual_search_terms.map(function(x){return x.trim()})
                    individual_search_terms = [...new Set(individual_search_terms)]


                    // search each tweet (b/c want to search each for multiple terms)
                    for(k=0;k<data_in.length;k++){

                         // create lunr index for tweet
                         var idx = lunr(function () {
                              this.ref('tweetid')
                              this.field('tweet_text')

                              data_in.slice(k,k+1).forEach(function (doc){
                                   this.add(doc)
                              }, this)
                         })

                         // eliminate prior search terms
                         data_in[k].contains = [];

                         //search tweet term by term
                         for(m=0;m<individual_search_terms.length;m++){

                              var curr_search = individual_search_terms[m]
                              var completed_search = idx.search(curr_search)

                              if(completed_search.length!=0){
                                   data_in[k].contains.push(individual_search_terms[m])
                              }
                         }

                         //if no new terms are found, add NA term
                         if(data_in[k].contains.length == 0){

                              data_in[k].contains=["NA"]
                         }

                    }

                    // only append terms that do not appear in the color dict, to maintain previous colors.
                    // jj index cycles through color_list
                    var terms_so_far = color_dict.map(elem=>elem.search_term)
                    var len_so_far = terms_so_far.length
                    for(i=0;i<individual_search_terms.length;i++){

                         // this is to maintain prior
                         if(!terms_so_far.includes(individual_search_terms[i])){
                              color_dict.push({"search_term":individual_search_terms[i],"num":len_so_far + 1 + jj, "color":color_list[jj]});

                              jj = jj+1

                         }
                    }


                    // get lists of just colors and terms form dictionary
                    var final_colors = color_dict.map(elem=>elem.color)
                    var final_terms = color_dict.map(elem=>elem.search_term)

                    function color_for_term(term){

                         var indexx = final_terms.indexOf(term)

                         return final_colors[indexx]
                    }


               // I might be able to save some time here by only updating tweets w hits on search terms
               // this seems harsh to remove all and redo them, but it is rough adding pie wedges for
               // yet- unknown search terms etc
               d3.selectAll(".pie")
                         .selectAll("path")
                         .remove()




               pie_groups.selectAll("path")
                             .data(function(d,i){

                                    var temp_data = d3.pie()(Array(data_in[i].contains.length).fill(1))

                                    // append the words to pass on to fill below, find a better way to do this?
                                    for(j=0;j<temp_data.length;j++){
                                              temp_data[j].word = data_in[i].contains[j]
                                    }

                                   return temp_data
                              })
                             .enter()
                             .append("path")
                             .attr("d",function(d,i,j){

                                             return d3.arc()
                                                       .innerRadius(set_inner_radius)
                                                       .outerRadius(set_outer_radius)(d)
                                       })
                             .attr("fill",function(d,i){
                                              return color_for_term(d.word)
                                             })

               d3.select("body")
                    .select("div.color_map_class")
                    .selectAll("svg")
                    .remove()

               // display color map for words, rough for now

               // add NA in at the beginning
               individual_search_terms.unshift("NA")



                    // display color map for words, rough for now
                    c_map_svg = d3.select("body")
                                   .select("div.color_map_class")
                                   .selectAll("svg")
                                   .data(individual_search_terms)
                                   .enter()
                                   .append("svg")
                                   .attr("height",3*c_map_y_inc)



                    c_map_svg.append("circle")
                              .attr("cx",c_map_x)
                              .attr("cy", 2*c_map_y_inc)
                              .attr("r",c_map_r)
                              .attr("fill", function(d,i){ return color_for_term(d) })

                    c_map_svg.append("text")
                                   .attr("x",c_map_x + 2*c_map_r)
                                   .attr("y", 2*c_map_y_inc+ c_map_r)
                                   .text(function(d,i){ return d })




               })// end button search:svg_button.select("circle").on("click",....)




          });//closes d3.csv(...)

     </script>

</body>
</html>
